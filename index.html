<html>

<head>
  <title>JSPython dev</title>
  <script src="./node_modules/ace-builds/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
  <script src="./dist/jspython-interpreter.js"></script>
  <script src="./dist/assets/mode-jspython.js"></script>
  <style>
    .container {
      height: 100%;
      min-width: 200px;
      width: 90%;
      margin: 10px auto;
    }

    #editor,
    #resultEditor {
      height: 40%;
      display: block;
      min-height: 20%;
      width: 100%;
      margin-top: 10px;
      margin-bottom: 10px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h4>JSPython development console</h4>
    <div id="editor">
x = { obj1: 2 + 4 }
x
    </div>
    <button onclick="tokenize()">Tokenize</button>
    <button onclick="parse()">Parse</button>
    <button onclick="runInterpreter()">Run</button>
    <div id="resultEditor"> </div>

    <!-- <textarea id="result"></textarea> -->
  </div>
  <script>

    const editor = ace.edit("editor");
    editor.setTheme("ace/theme/monokai");
    editor.session.setMode("ace/mode/python");

    const resultEditor = ace.edit("resultEditor");
    resultEditor.setTheme("ace/theme/monokai");
    resultEditor.session.setMode("ace/mode/json");

    const jsPython = jspython.jsPython;
    function tokenize() {
      tokenizer = (s) => console.log(`tokens => ${s}`, jsPython().tokenize(s))

      const scripts = editor.getValue();
      try {
        const result = jsPython()
          .tokenize(scripts)
          .map((t, i) => `${t[1]} : '${t[0]}'`)
          .join('\n');

        const data = typeof result === 'object' ? JSON.stringify(result, null, '\t') : result;
        resultEditor.getSession().setValue(data)
      } catch (err) {
        console.error(err);
        resultEditor.getSession().setValue('Error:\n' + String(err))
      }
    }

    async function parse() {

      const scripts = editor.getValue();
      try {
        const result = await jsPython()
          .parse(scripts);

        const data = typeof result === 'object' ? JSON.stringify(result, null, '\t') : result;
        resultEditor.getSession().setValue(data)
      } catch (err) {
        console.error(err);
        resultEditor.getSession().setValue('Error:\n' + String(err))
      }
    }

    async function runInterpreter() {

      const scripts = editor.getValue();
      try {
        const scope = {
          Math,
          print: (p1, p2) => {return p1;},
          x: 10,
          o: {
            f1: (x,y) => {return {x, y};},
            v1: 55,
            sub1: {
              subValue: 88
            }
          }
        };
        const result = await jsPython()
          .evaluate(scripts, scope);

        const data = typeof result === 'object' ? JSON.stringify(result, null, '\t') : String(result);
        resultEditor.getSession().setValue(data)
      } catch (err) {
        console.error(err);
        resultEditor.getSession().setValue('Error:\n' + String(err))
      }
    }

  </script>
</body>

</html>